<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Symulator incydentu z dronami — moduł służb i monitoringu (Kutno)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{
      --bg:#0b0f10; --panel:#0f1417; --acc:#4bd1ff; --text:#e4f6ff; --mut:#a8c3cf; --good:#68ff8b; --warn:#ffd166; --bad:#ff6363;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif; background:linear-gradient(120deg,#0b0f10,#0a1317 60%,#091218); color:var(--text);}
    .app{display:grid; grid-template-columns:1fr 380px; grid-template-rows:auto 1fr; height:100%}
    header{grid-column:1/3; display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid #12222a; background:#0b1216cc; backdrop-filter: blur(6px); position:sticky; top:0; z-index:20}
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    header .badge{margin-left:auto; font-size:12px; color:#02212b; background:var(--acc); padding:6px 10px; border-radius:999px; font-weight:700}
    #map{height:calc(100vh - 56px)}
    aside{border-left:1px solid #12222a; background:linear-gradient(180deg,#0e1419,#0b1115); padding:14px; overflow:auto}

    .panel{display:grid; gap:12px}
    .card{background:var(--panel); border:1px solid #13232b; border-radius:14px; padding:12px; box-shadow:0 8px 20px #00000030}
    .card h3{margin:0 0 8px; font-size:14px; letter-spacing:.4px; color:var(--acc)}

    .controls{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .btn{cursor:pointer; border:none; border-radius:10px; padding:10px 12px; font-weight:700; letter-spacing:.2px; color:#041c25; transition:.2s transform,.2s filter}
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05)}
    .btn:active{transform:translateY(0)}
    .btn-acc{background:var(--acc)}
    .btn-warn{background:var(--warn)}
    .btn-good{background:var(--good); color:#04230e}
    .btn-bad{background:var(--bad)}
    .btn-ghost{background:#0c171d; color:var(--mut); border:1px dashed #27414e}

    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
    .stat{background:#0c1216; border:1px solid #16313b; border-radius:12px; padding:8px; text-align:center}
    .stat .v{font-size:18px; font-weight:800}
    .stat .k{font-size:11px; color:var(--mut)}

    .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:12px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; background:#0c171d; border:1px solid #27414e; border-radius:999px}
    .dot{width:10px; height:10px; border-radius:50%}

    .log{max-height:180px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; line-height:1.35; background:#0b1115; border:1px solid #162831; border-radius:10px; padding:8px}
    .log p{margin:0 0 6px}

    .units{display:grid; gap:8px}
    .unit{display:flex; align-items:center; justify-content:space-between; background:#0c1216; border:1px solid #16313b; border-radius:10px; padding:8px 10px}
    .unit .n{font-weight:700}

    .footer-actions{display:flex; gap:8px}

    .notice{font-size:12px; color:var(--mut)}

    .report{position:fixed; inset:0; display:none; place-items:center; background:#0009; z-index:40}
    .report .box{width:min(760px,92vw); background:#0d1418; border:1px solid #15313b; border-radius:14px; padding:16px}
    .report .box h2{margin:0 0 8px; color:var(--acc)}
    .rep-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .rep-grid .cell{background:#0c1216; border:1px solid #16313b; border-radius:10px; padding:10px}

    /* Drone visuals */
    .drone-visual{
      width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#041017; font-weight:800;
      box-shadow:0 0 12px rgba(255,99,99,0.18), 0 0 28px rgba(255,159,28,0.12);
      background:radial-gradient(circle at 35% 25%, #ff9f1c, #ff6161 60%);
      border:2px solid rgba(0,0,0,0.25);
      transform:rotate(0deg);
    }
    .drone-visual.threat{ background: linear-gradient(180deg,#ff6161,#ff9f1c); box-shadow:0 0 18px #ff9f1c88,0 0 40px #ff6161aa; }
    .drone-visual .tri{ width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid rgba(4,2,2,0.95); position:relative; top:-1px }
    @keyframes pulseBright { 0%{ box-shadow:0 0 6px #ff9f1c66,0 0 16px #ff616144 } 50%{ box-shadow:0 0 20px #ff9f1c88,0 0 36px #ff6161aa } 100%{ box-shadow:0 0 6px #ff9f1c66,0 0 16px #ff616144 } }
    .drone-visual.pulse{ animation: pulseBright 1.6s infinite ease-in-out }

    .drone-label{ font-size:11px; background:#0c1216cc; padding:3px 6px; border-radius:6px; border:1px solid #16313b; color:var(--text); font-weight:700 }

    /* Leaflet overrides for dark UI */
    .leaflet-popup-content-wrapper,.leaflet-popup-tip{background:#0e1519; color:#e7f6ff; border:1px solid #16313b}
    .leaflet-control-attribution{background:#0b0f10cc; color:#9cc6d3; backdrop-filter: blur(4px)}
  </style>
</head>
<body>
<div class="app">
  <header>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2l3 7h7l-5.5 4 2.5 7-7-4-7 4 2.5-7L2 9h7l3-7z" stroke="#4bd1ff" stroke-width="1.4"/>
    </svg>
    <h1>Symulator incydentu z dronami — <span style="color:var(--acc)">Kutno</span></h1>
    <span class="badge" id="status">STAN: ĆWICZENIA</span>
  </header>

  <main id="map"></main>

  <aside>
    <div class="panel">
      <div class="card">
        <h3>Panel decyzyjny</h3>
        <div class="controls">
          <button class="btn btn-acc" id="btnAlert">Komunikat RCB</button>
          <button class="btn btn-warn" id="btnCloseAir">Zamknij przestrzeń</button>
          <button class="btn btn-good" id="btnNotify">Powiadom służby</button>
          <button class="btn btn-ghost" id="btnEvac">Ewakuacja punktowa</button>
        </div>
        <div class="legend" style="margin-top:10px">
          <span class="pill"><span class="dot" style="background:#39d2ff"></span> Dron (śledzony)</span>
          <span class="pill"><span class="dot" style="background:#ff9f1c"></span> Strefa buforowa</span>
          <span class="pill"><span class="dot" style="background:#68ff8b"></span> Jednostka służb</span>
          <span class="pill"><span class="dot" style="background:#ff6363"></span> Naruszenie</span>
        </div>
      </div>

      <div class="card">
        <h3>Szybkie statystyki</h3>
        <div class="grid-3">
          <div class="stat"><div class="v" id="statDrones">0</div><div class="k">Aktywne drony</div></div>
          <div class="stat"><div class="v" id="statViol">0</div><div class="k">Naruszenia</div></div>
          <div class="stat"><div class="v" id="statPanic">3%</div><div class="k">Poziom paniki</div></div>
        </div>
      </div>

      <div class="card">
        <h3>Jednostki w terenie</h3>
        <div class="units" id="units"></div>
      </div>

      <div class="card">
        <h3>Dziennik zdarzeń</h3>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <h3>Raport i reset</h3>
        <div class="footer-actions">
          <button class="btn btn-acc" id="btnReport">Zakończ i raport</button>
          <button class="btn btn-ghost" id="btnReset">Reset symulacji</button>
        </div>
        <p class="notice" style="margin-top:8px">Edukacyjny moduł ćwiczebny. Brak elementów ofensywnych. Dane mapowe: OpenStreetMap.</p>
      </div>
    </div>
  </aside>
</div>

<!-- Modal raportu -->
<div class="report" id="reportModal" aria-hidden="true">
  <div class="box">
    <h2>Raport ćwiczenia</h2>
    <div class="rep-grid">
      <div class="cell"><b>Czas trwania:</b> <span id="repTime">—</span></div>
      <div class="cell"><b>Aktywne drony:</b> <span id="repDrones">—</span></div>
      <div class="cell"><b>Naruszenia:</b> <span id="repViol">—</span></div>
      <div class="cell"><b>Wysłane jednostki:</b> <span id="repUnits">—</span></div>
      <div class="cell" style="grid-column:1/3"><b>Rekomendacje:</b>
        <ul id="repRec" style="margin:6px 0 0 18px">
          <li>Utrzymuj stały monitoring stref buforowych.</li>
          <li>Skaluj komunikację RCB w oparciu o potwierdzone zdarzenia.</li>
          <li>Testuj redundancję łączności dowodzenia.</li>
        </ul>
      </div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
      <button class="btn btn-good" id="btnCloseReport">Zamknij</button>
    </div>
  </div>
</div>

<script>
(function(){
  // —— USTAWIENIA ——
  const KUTNO = [52.231, 19.364]; // przybliżone współrzędne Kutna
  const POINTS = [
    {name:"Szpital Kutno", pos:[52.2319,19.3714]},
    {name:"Dworzec PKP", pos:[52.2293,19.3593]},
    {name:"Rynek / Ratusz", pos:[52.2303,19.3609]},
    {name:"Kampus uczelniany (przykładowo)", pos:[52.2287,19.3680]},
  ];

  const BUFFER_RADIUS_M = 350; // strefa buforowa wokół punktów w metrach
  const DRONE_COUNT = 4;       // liczba dronów w symulacji
  const MOVE_MS = 1200;        // interwał przemieszczeń

  // —— STAN ——
  const state = {
    startedAt: Date.now(),
    drones: [],
    units: [
      { id:"PSP-1", type:"PSP", available:true },
      { id:"PSP-2", type:"PSP", available:true },
      { id:"POL-1", type:"Policja", available:true },
      { id:"POL-2", type:"Policja", available:true },
      { id:"ZRM-1", type:"ZRM", available:true },
      { id:"SM-1", type:"Straż Miejska", available:true },
    ],
    alerts: { rcb:false, airspaceClosed:false },
    stats: { violations:0, panic:3 },
  };

  // —— MAPA ——
  const map = L.map('map',{ zoomControl:true, minZoom:12, maxZoom:18 }).setView(KUTNO, 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  // Punkty newralgiczne + bufory
  const buffers = [];
  POINTS.forEach(p=>{
    L.marker(p.pos).addTo(map).bindPopup(`<b>${p.name}</b>`);
    const buf = L.circle(p.pos, {radius:BUFFER_RADIUS_M, color:'#ff9f1c', weight:1, fillColor:'#ff9f1c', fillOpacity:0.08});
    buf.addTo(map);
    buffers.push({layer:buf, center:p.pos});
  });

  // —— UTYLITY ——
  const logEl = document.getElementById('log');
  function log(msg){
    const t = new Date().toLocaleTimeString();
    const p = document.createElement('p');
    p.innerHTML = `[${t}] ${msg}`;
    logEl.prepend(p);
  }
  function rnd(a,b){ return a + Math.random()*(b-a); }
  function jitterCoord([lat,lng], m=250){
    // przesunięcie o ok. m w metrach
    const dLat = (m/111111) * (Math.random()-.5);
    const dLng = (m/(111111*Math.cos(lat*Math.PI/180))) * (Math.random()-.5);
    return [lat + dLat, lng + dLng];
  }
  function inAnyBuffer(latlng){
    return buffers.some(b=> map.distance(latlng, b.center) <= BUFFER_RADIUS_M);
  }
  function updateStats(){
    document.getElementById('statDrones').textContent = state.drones.length;
    document.getElementById('statViol').textContent = state.stats.violations;
    document.getElementById('statPanic').textContent = `${state.stats.panic}%`;
  }

  // —— DRONY ——
  function makeDroneIcon({threat=false, label='—'}){
    const el = document.createElement('div');
    el.className = 'drone-visual' + (threat? ' threat pulse':'');
    el.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center"><div class='tri'></div><div style='font-size:10px;margin-top:2px'>${label}</div></div>`;
    return L.divIcon({className:'', html:el.outerHTML, iconSize:[44,44], iconAnchor:[22,22]});
  }

  const DRONE_TYPES = [ 'REKONESANS', 'TOWAROWY', 'UDERZENIOWY', 'INSPEKCYJNY' ];

  function detectTypeProbabilistic(){
    // 60% chance to detect correct type, 25% to detect generic, 15% unknown
    const r = Math.random();
    if(r<0.6) return DRONE_TYPES[Math.floor(Math.random()*DRONE_TYPES.length)];
    if(r<0.85) return 'NIEPEŁNA_IDENTYFIKACJA';
    return 'NIEZNANY';
  }

  function spawnDrone(){
    const start = jitterCoord(KUTNO, 900);
    const detected = detectTypeProbabilistic();
    const marker = L.marker(start,{icon: makeDroneIcon({threat:false,label:detected==='NIEZNANY'?'?':detected.slice(0,3)})}).addTo(map);
    marker.bindPopup(`<b>Dron</b><br/><b>Typ (detekcja):</b> ${detected==='NIEZNANY' ? '<span style="color:#ffd166">NIEZNANY</span>' : detected}`);
    // stały tooltip z pełnym typem/nieznany
    marker.bindTooltip(detected, {permanent:true, direction:'top', className:'drone-label'}).openTooltip();
    const path = [start, jitterCoord(KUTNO, 700), jitterCoord(KUTNO, 700), jitterCoord(KUTNO, 700)];
    const d = { marker, pathIndex:0, path, detectedType:detected, trueType: DRONE_TYPES[Math.floor(Math.random()*DRONE_TYPES.length)] };
    state.drones.push(d);
    log(`Nowy obiekt powietrzny śledzony — detekcja: <b>${d.detectedType}</b>`);
  }
  for(let i=0;i<DRONE_COUNT;i++) spawnDrone();

  function setMarkerThreatVisual(d, isThreat){
    // aktualizuj ikonę i tooltip
    const label = isThreat ? (d.detectedType==='NIEZNANY' ? '?!' : d.detectedType.slice(0,3)) : (d.detectedType==='NIEZNANY' ? '?' : d.detectedType.slice(0,3));
    d.marker.setIcon(makeDroneIcon({threat:isThreat,label}));
    d.marker.setPopupContent(`<b>Dron</b><br/><b>Typ (detekcja):</b> ${d.detectedType==='NIEZNANY' ? '<span style="color:#ffd166">NIEZNANY</span>' : d.detectedType}<br/><b>Typ (prawdopodobny):</b> ${d.trueType}`);
    d.marker.unbindTooltip();
    d.marker.bindTooltip(d.detectedType, {permanent:true, direction:'top', className:'drone-label'}).openTooltip();
  }

  function moveDrones(){
    state.drones.forEach(d=>{
      d.pathIndex = (d.pathIndex + 1) % d.path.length;
      const next = d.path[d.pathIndex];
      d.marker.setLatLng(next);
      const violation = inAnyBuffer(next);
      if(violation){
        state.stats.violations++;
        setMarkerThreatVisual(d, true);
        log(`<span style="color:var(--bad)">Naruszenie strefy buforowej</span> — dron wykryty przy punkcie wrażliwym. Detekcja: <b>${d.detectedType}</b>`);
      } else {
        setMarkerThreatVisual(d, false);
      }
    });
    // panika lekko rośnie, jeśli brak reakcji
    if(!state.alerts.rcb && state.stats.panic < 30){ state.stats.panic += 1; }
    updateStats();
  }
  const timer = setInterval(moveDrones, MOVE_MS);

  // —— JEDNOSTKI ——
  const unitsEl = document.getElementById('units');
  function renderUnits(){
    unitsEl.innerHTML = '';
    state.units.forEach(u=>{
      const row = document.createElement('div');
      row.className = 'unit';
      row.innerHTML = `<span class="n">${u.id}</span><span class="t" style="color:${u.available? 'var(--good)':'var(--warn)'}">${u.available? 'gotowa':'w akcji'}</span>`;
      const btn = document.createElement('button');
      btn.className = 'btn btn-acc';
      btn.textContent = u.available ? 'Wyślij' : 'Przywróć';
      btn.onclick = ()=>{
        if(u.available){
          // wyślij w pobliże najbliższego drona
          const target = state.drones[ Math.floor(Math.random()*state.drones.length) ];
          if(target){
            L.marker(target.marker.getLatLng(),{icon: L.divIcon({html:'<div style="width:12px;height:12px;border-radius:50%;background:#68ff8b"></div>', iconSize:[12,12], iconAnchor:[6,6]})}).addTo(map).bindPopup(`Jednostka ${u.id}`);
            u.available = false;
            log(`Jednostka <b>${u.id}</b> wysłana w rejon aktywności drona (detekcja: ${target.detectedType}).`);
          }
        } else {
          u.available = true;
          log(`Jednostka <b>${u.id}</b> powróciła i jest gotowa.`);
        }
        renderUnits();
      };
      row.appendChild(btn);
      unitsEl.appendChild(row);
    });
  }
  renderUnits();

  // —— AKCJE PANELU ——
  document.getElementById('btnAlert').onclick = ()=>{
    state.alerts.rcb = true;
    document.getElementById('status').textContent = 'STAN: ALARM INFORMACYJNY RCB';
    log('<b>Komunikat RCB</b> — przekazano zalecenia zachowania spokoju i unikania skupisk.');
    // panika maleje po komunikacie
    state.stats.panic = Math.max(1, state.stats.panic - 2);
    updateStats();
  };
  document.getElementById('btnCloseAir').onclick = ()=>{
    state.alerts.airspaceClosed = true;
    log('<b>Zamknięto czasowo przestrzeń powietrzną</b> nad obszarem miasta. Poinformowano PAŻP.');
  };
  document.getElementById('btnNotify').onclick = ()=>{
    log('<b>Powiadomiono służby</b>: Policja, PSP, ZRM, SM, WOT. Ustalono kanały łączności.');
  };
  document.getElementById('btnEvac').onclick = ()=>{
    log('Zarządzono <b>ewakuację punktową</b> na terenie obiektu wrażliwego.');
    state.stats.panic = Math.min(75, state.stats.panic + 3);
    updateStats();
  };

  document.getElementById('btnReset').onclick = ()=>{
    clearInterval(timer);
    location.reload();
  };

  // —— RAPORT ——
  const modal = document.getElementById('reportModal');
  document.getElementById('btnReport').onclick = ()=>{
    const durMs = Date.now() - state.startedAt;
    const mins = Math.floor(durMs/60000), secs = Math.floor((durMs%60000)/1000);
    document.getElementById('repTime').textContent = `${mins}m ${secs}s`;
    document.getElementById('repDrones').textContent = state.drones.length;
    document.getElementById('repViol').textContent = state.stats.violations;
    document.getElementById('repUnits').textContent = state.units.filter(u=>!u.available).length;

    // proste rekomendacje
    const rec = document.getElementById('repRec');
    rec.innerHTML = '';
    const li = (t)=>{ const x=document.createElement('li'); x.textContent=t; rec.appendChild(x); };
    if(state.stats.violations>2) li('Rozważ zwiększenie liczby patroli dronów obserwacyjnych / punktów detekcji.');
    if(!state.alerts.rcb) li('Komunikat RCB nie został uruchomiony — rozważ szybszą aktywację.');
    if(state.units.filter(u=>!u.available).length===0) li('Brak wysłanych jednostek — w realnym scenariuszu niezbędna interwencja.');
    if(rec.children.length===0) li('Działania skoordynowane prawidłowo w czasie symulacji.');

    modal.style.display = 'grid';
    modal.setAttribute('aria-hidden','false');
  };
  document.getElementById('btnCloseReport').onclick = ()=>{
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  };

  // Start log
  log('Symulacja uruchomiona. Monitorowanie ruchu obiektów powietrznych nad Kutnem.');
})();
</script>
</body>
</html>