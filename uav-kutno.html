<!doctype html>

<html lang="pl">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Symulator incydentu z dronami — moduł służb i monitoringu (Kutno)</title>

  <!-- Leaflet -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>

    :root{

      --bg:#0b0f10; --panel:#0f1417; --acc:#4bd1ff; --text:#e4f6ff; --mut:#a8c3cf; --good:#68ff8b; --warn:#ffd166; --bad:#ff6363;

    }

    *{box-sizing:border-box}

    html,body{height:100%}

    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif; background:linear-gradient(120deg,#0b0f10,#0a1317 60%,#091218); color:var(--text)}

    .app{display:grid; grid-template-columns:1fr 380px; grid-template-rows:auto 1fr; height:100%}

    header{grid-column:1/3; display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid #12222a; background:#0b1216cc; backdrop-filter: blur(6px); position:sticky; top:0; z-index:30}

    header h1{font-size:18px; margin:0; letter-spacing:.3px}

    header .badge{margin-left:auto; font-size:12px; color:#02212b; background:var(--acc); padding:6px 10px; border-radius:999px; font-weight:700}

    #map{height:calc(100vh - 56px); z-index:0 !important}

    .leaflet-container{z-index:0 !important}

    aside{border-left:1px solid #12222a; background:linear-gradient(180deg,#0e1419,#0b1115); padding:14px; overflow:auto}



    .panel{display:grid; gap:12px}

    .card{background:var(--panel); border:1px solid #13232b; border-radius:14px; padding:12px; box-shadow:0 8px 20px #00000030}

    .card h3{margin:0 0 8px; font-size:14px; letter-spacing:.4px; color:var(--acc)}



    .controls{display:grid; grid-template-columns:1fr 1fr; gap:8px}

    .btn{cursor:pointer; border:none; border-radius:10px; padding:10px 12px; font-weight:700; letter-spacing:.2px; color:#041c25; transition:.2s transform,.2s filter}

    .btn:hover{transform:translateY(-1px); filter:brightness(1.05)}

    .btn:active{transform:translateY(0)}

    .btn-acc{background:var(--acc)}

    .btn-warn{background:var(--warn)}

    .btn-good{background:var(--good); color:#04230e}

    .btn-bad{background:var(--bad)}

    .btn-ghost{background:#0c171d; color:var(--mut); border:1px dashed #27414e}



    .grid-4{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}

    .stat{background:#0c1216; border:1px solid #16313b; border-radius:12px; padding:8px; text-align:center}

    .stat .v{font-size:18px; font-weight:800}

    .stat .k{font-size:11px; color:var(--mut)}



    .legend{display:flex; gap:8px; flex-wrap:wrap; font-size:12px}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; background:#0c171d; border:1px solid #27414e; border-radius:999px}

    .dot{width:10px; height:10px; border-radius:50%}



    .log{max-height:180px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; line-height:1.35; background:#0b1115; border:1px solid #162831; border-radius:10px; padding:8px}

    .log p{margin:0 0 6px}



    .units{display:grid; gap:8px}

    .unit{display:flex; align-items:center; justify-content:space-between; background:#0c1216; border:1px solid #16313b; border-radius:10px; padding:8px 10px}

    .unit .n{font-weight:700}



    .footer-actions{display:flex; gap:8px}

    .notice{font-size:12px; color:var(--mut)}



    /* Modale zawsze nad mapą */

    .modal{position:fixed; inset:0; display:none; place-items:center; background:#000c; z-index:10000}

    .modal .box{width:min(680px,92vw); background:#0d1418; border:1px solid #15313b; border-radius:14px; padding:16px}

    .modal h2{margin:0 0 8px; color:var(--acc); font-size:18px}

    .modal .row{display:flex; gap:10px; align-items:center; margin:8px 0}

    .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

    .modal label{font-size:13px}

    .modal input[type="number"], .modal input[type="text"], .modal textarea, .modal select{

      width:100%; padding:8px; border-radius:10px; border:1px solid #16313b; background:#0c1216; color:var(--text); font-family:inherit

    }

    .hint{font-size:12px; color:var(--mut)}



    /* Raport modal */

    .report{position:fixed; inset:0; display:none; place-items:center; background:#0009; z-index:9999}

    .report .box{width:min(760px,92vw); background:#0d1418; border:1px solid #15313b; border-radius:14px; padding:16px}

    .report .box h2{margin:0 0 8px; color:var(--acc)}

    .rep-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .rep-grid .cell{background:#0c1216; border:1px solid #16313b; border-radius:10px; padding:10px}



    /* Drone visuals */

    .drone-visual{

      width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#041017; font-weight:800;

      box-shadow:0 0 12px rgba(255,99,99,0.18), 0 0 28px rgba(255,159,28,0.12);

      background:radial-gradient(circle at 35% 25%, #ff9f1c, #ff6161 60%);

      border:2px solid rgba(0,0,0,0.25);

    }

    .drone-visual.threat{ background: linear-gradient(180deg,#ff6161,#ff9f1c); box-shadow:0 0 18px #ff9f1c88,0 0 40px #ff6161aa; }

    .drone-visual .tri{ width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid rgba(4,2,2,0.95); position:relative; top:-1px }

    @keyframes pulseBright { 0%{ box-shadow:0 0 6px #ff9f1c66,0 0 16px #ff616144 } 50%{ box-shadow:0 0 20px #ff9f1c88,0 0 36px #ff6161aa } 100%{ box-shadow:0 0 6px #ff9f1c66,0 0 16px #ff616144 } }

    .drone-visual.pulse{ animation: pulseBright 1.6s infinite ease-in-out }

    .drone-label{ font-size:11px; background:#0c1216cc; padding:3px 6px; border-radius:6px; border:1px solid #16313b; color:var(--text); font-weight:700 }



    /* Panic dots */

    .panic-dot {width:16px;height:16px;border-radius:50%; background:#ff5252aa; border:1px solid #ff9f9f; box-shadow:0 0 12px #ff3d3daa}

    @keyframes panicPulse{0%{transform:scale(.9);opacity:.9}50%{transform:scale(1.25);opacity:1}100%{transform:scale(.9);opacity:.9}}

    .panic-anim{animation:panicPulse 1.1s infinite ease-in-out}



    /* Toasts */

    .toast{position:fixed; right:14px; bottom:14px; display:grid; gap:8px; z-index:12000}

    .toast .t{background:#0d1418; border:1px solid #1b3b46; color:#c9edf9; padding:10px 12px; border-radius:10px; box-shadow:0 6px 16px #0008; font-size:13px}



    /* RCB banner */

    .rcb-banner{position:fixed; left:50%; transform:translateX(-50%); top:56px; background:#102a33; border:1px solid #1a5d74; color:#c9f1ff; padding:8px 12px; border-radius:10px; z-index:9000; display:none}



    /* Strefa ataku: miganie */

    .leaflet-interactive.attack-zone { animation: flashRed 0.9s ease-in-out infinite; stroke: #ff2d2d !important; }

    @keyframes flashRed{ 0%{fill-opacity:.12;stroke-opacity:.9}50%{fill-opacity:.35;stroke-opacity:1}100%{fill-opacity:.12;stroke-opacity:.9} }

    .impact-dot {width:18px;height:18px;border-radius:50%;

      background: radial-gradient(circle at 45% 40%, #ffb4b4, #ff3030 60%, #7a0000 100%);

      box-shadow:0 0 18px #ff3c3c, 0 0 36px #ff000055;

      border:1px solid #4d0000}

  </style>

</head>

<body>

<div class="app">

  <header>

    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">

      <path d="M12 2l3 7h7l-5.5 4 2.5 7-7-4-7 4 2.5-7L2 9h7l3-7z" stroke="#4bd1ff" stroke-width="1.4"/>

    </svg>

    <h1>Symulator incydentu z dronami — <span style="color:var(--acc)">Kutno</span></h1>

    <span class="badge" id="status">STAN: ĆWICZENIA</span>

  </header>



  <main id="map"></main>



  <aside>

    <div class="panel">

      <div class="card">

        <h3>Panel decyzyjny</h3>

        <div class="controls">

          <button class="btn btn-acc" id="btnAlert">Komunikat RCB</button>

          <button class="btn btn-warn" id="btnCloseAir">Zamknij przestrzeń</button>

          <button class="btn btn-good" id="btnNotify">Powiadom służby</button>

          <button class="btn btn-ghost" id="btnEvac">Panika/Ewakuacja</button>

        </div>

        <div class="legend" style="margin-top:10px">

          <span class="pill"><span class="dot" style="background:#39d2ff"></span> Dron (śledzony)</span>

          <span class="pill"><span class="dot" style="background:#ff9f1c"></span> Strefa buforowa</span>

          <span class="pill"><span class="dot" style="background:#68ff8b"></span> Jednostka służb</span>

          <span class="pill"><span class="dot" style="background:#ff6363"></span> Naruszenie</span>

          <span class="pill"><span class="dot" style="background:#ff5252"></span> Ognisko paniki</span>

          <span class="pill"><span class="dot" style="background:#a66cff"></span> No-fly (czasowe)</span>

        </div>

      </div>



      <div class="card">

        <h3>Szybkie statystyki</h3>

        <div class="grid-4">

          <div class="stat"><div class="v" id="statDrones">0</div><div class="k">Aktywne drony</div></div>

          <div class="stat"><div class="v" id="statViol">0</div><div class="k">Naruszenia</div></div>

          <div class="stat"><div class="v" id="statPanic">3%</div><div class="k">Poziom paniki</div></div>

          <div class="stat"><div class="v" id="statCas">0</div><div class="k">Ofiary śmiertelne</div></div>

        </div>

      </div>



      <div class="card">

        <h3>Jednostki w terenie</h3>

        <div class="units" id="units"></div>

      </div>



      <div class="card">

        <h3>Dziennik zdarzeń</h3>

        <div class="log" id="log"></div>

      </div>



      <div class="card">

        <h3>Raport i reset</h3>

        <div class="footer-actions">

          <button class="btn btn-acc" id="btnReport">Zakończ i raport</button>

          <button class="btn btn-ghost" id="btnReset">Reset symulacji</button>

        </div>

        <p class="notice" style="margin-top:8px">Edukacyjny moduł ćwiczebny. Brak elementów ofensywnych. Dane mapowe: OpenStreetMap.</p>

      </div>

    </div>

  </aside>

</div>



<!-- RCB banner -->

<div class="rcb-banner" id="rcbBanner">RCB: Zachowaj spokój, unikaj skupisk, śledź komunikaty.</div>



<!-- Toast stack -->

<div class="toast" id="toast"></div>



<!-- Modal: RCB -->

<div class="modal" id="modalAlert">

  <div class="box">

    <h2>Komunikat RCB</h2>

    <div class="row"><textarea id="rcbText" rows="4">UWAGA! W rejonie miasta wykryto aktywność dronów. Zachowaj spokój, unikaj skupisk, postępuj zgodnie z poleceniami służb.</textarea></div>

    <div class="row hint">Po zatwierdzeniu komunikat pojawi się jako baner; panika mieszkańców spadnie o 2–5 pp.</div>

    <div class="actions">

      <button class="btn btn-ghost" data-close="modalAlert">Anuluj</button>

      <button class="btn btn-acc" id="rcbSend">Wyślij komunikat</button>

    </div>

  </div>

</div>



<!-- Modal: No-fly zone -->

<div class="modal" id="modalAir">

  <div class="box">

    <h2>Zamknięcie przestrzeni (no-fly)</h2>

    <div class="row">

      <label style="min-width:140px">Promień (m):</label>

      <input type="number" id="airRadius" value="800" min="200" max="3000" step="50">

    </div>

    <div class="row hint">Wybierz punkt na mapie, aby wyznaczyć środek strefy. Możesz dodać wiele stref.</div>

    <div class="actions">

      <button class="btn btn-ghost" data-close="modalAir">Zamknij</button>

      <button class="btn btn-warn" id="airArm">Uaktywnij tryb wskazania na mapie</button>

      <button class="btn btn-good" id="airClear">Usuń wszystkie strefy</button>

    </div>

  </div>

</div>



<!-- Modal: Notify services -->

<div class="modal" id="modalNotify">

  <div class="box">

    <h2>Powiadom służby</h2>

    <div class="row" style="flex-wrap:wrap">

      <label><input type="checkbox" class="srv" value="Policja" checked> Policja</label>

      <label><input type="checkbox" class="srv" value="PSP" checked> PSP</label>

      <label><input type="checkbox" class="srv" value="ZRM" checked> ZRM</label>

      <label><input type="checkbox" class="srv" value="Straż Miejska" checked> Straż Miejska</label>

      <label><input type="checkbox" class="srv" value="WOT"> WOT</label>

    </div>

    <div class="row">

      <label style="min-width:160px">Liczba jednostek (łącznie):</label>

      <input type="number" id="srvCount" value="3" min="1" max="10">

    </div>

    <div class="row hint">Jednostki pojawią się na mapie i wyruszą do najbliższego drona (animowany dojazd).</div>

    <div class="actions">

      <button class="btn btn-ghost" data-close="modalNotify">Anuluj</button>

      <button class="btn btn-good" id="srvDispatch">Wyślij</button>

    </div>

  </div>

</div>



<!-- Modal: Panic/Evac -->

<div class="modal" id="modalPanic">

  <div class="box">

    <h2>Panika / Ewakuacja punktowa</h2>

    <div class="row">

      <label style="min-width:160px">Liczba ognisk paniki:</label>

      <input type="number" id="panicCount" value="5" min="1" max="30">

    </div>

    <div class="row">

      <label style="min-width:160px">Promień ogniska (m):</label>

      <input type="number" id="panicRadius" value="120" min="40" max="400" step="10">

    </div>

    <div class="row">

      <label style="min-width:160px">Wzrost paniki (pp):</label>

      <input type="number" id="panicDelta" value="7" min="1" max="20">

    </div>

    <div class="row hint">Kliknij w mapę, aby dodać ognisko. Albo użyj auto-rozmieszczenia w centrum.</div>

    <div class="actions">

      <button class="btn btn-ghost" data-close="modalPanic">Zamknij</button>

      <button class="btn btn-bad" id="panicArm">Tryb dodawania na mapie</button>

      <button class="btn btn-warn" id="panicAuto">Auto-rozmieszczenie</button>

      <button class="btn btn-good" id="panicClear">Wyczyść</button>

    </div>

  </div>

</div>



<!-- Modal raportu -->

<div class="report" id="reportModal" aria-hidden="true">

  <div class="box">

    <h2>Raport ćwiczenia</h2>

    <div class="rep-grid">

      <div class="cell"><b>Czas trwania:</b> <span id="repTime">—</span></div>

      <div class="cell"><b>Aktywne drony:</b> <span id="repDrones">—</span></div>

      <div class="cell"><b>Naruszenia:</b> <span id="repViol">—</span></div>

      <div class="cell"><b>Wysłane jednostki:</b> <span id="repUnits">—</span></div>

      <div class="cell" style="grid-column:1/3"><b>Rekomendacje:</b>

        <ul id="repRec" style="margin:6px 0 0 18px">

          <li>Utrzymuj stały monitoring stref buforowych.</li>

          <li>Skaluj komunikację RCB w oparciu o potwierdzone zdarzenia.</li>

          <li>Testuj redundancję łączności dowodzenia.</li>

        </ul>

      </div>

    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">

      <button class="btn btn-good" id="btnCloseReport">Zamknij</button>

    </div>

  </div>

</div>



<script>

(function(){

  // —— USTAWIENIA —— //

  const KUTNO = [52.231, 19.364];

  const POINTS = [

    {name:"Szpital Kutno", pos:[52.2319,19.3714]},

    {name:"Dworzec PKP", pos:[52.2293,19.3593]},

    {name:"Rynek / Ratusz", pos:[52.2303,19.3609]},

    {name:"Kampus uczelniany (przykładowo)", pos:[52.2287,19.3680]},

  ];

  const BUFFER_RADIUS_M = 350;

  const DRONE_COUNT = 4;

  const MOVE_MS = 1200;



  // —— STAN —— //

  const state = {

    startedAt: Date.now(),

    drones: [],

    units: [

      { id:"PSP-1", type:"PSP", available:true },

      { id:"PSP-2", type:"PSP", available:true },

      { id:"POL-1", type:"Policja", available:true },

      { id:"POL-2", type:"Policja", available:true },

      { id:"ZRM-1", type:"ZRM", available:true },

      { id:"SM-1", type:"Straż Miejska", available:true },

    ],

    alerts: { rcb:false, airspaceClosed:false },

    stats: { violations:0, panic:3, casualties:0 },

    overlays: { nofly:[], panic:[] },

    armed: { air:false, panic:false }

  };



  // —— MAPA —— //

  const map = L.map('map',{ zoomControl:true, minZoom:12, maxZoom:18 }).setView(KUTNO, 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

    maxZoom: 19,

    attribution: '&copy; OpenStreetMap'

  }).addTo(map);



  // HUD: czas trwania

  const hud = L.control({position:'bottomleft'});

  hud.onAdd = function(){

    const el = L.DomUtil.create('div','hud');

    el.style.background='#0d1418cc'; el.style.border='1px solid #16313b'; el.style.padding='6px 8px'; el.style.borderRadius='10px'; el.style.fontSize='12px';

    el.id='hudTime'; el.innerHTML='Czas: 0m 0s';

    return el;

  };

  hud.addTo(map);

  setInterval(()=>{

    const d=Date.now()-state.startedAt; const m=Math.floor(d/60000); const s=Math.floor((d%60000)/1000);

    const hudEl=document.getElementById('hudTime'); if(hudEl) hudEl.innerHTML=`Czas: ${m}m ${s}s`;

  },1000);



  // Punkty + bufory

  const buffers = [];

  POINTS.forEach(p=>{

    L.marker(p.pos).addTo(map).bindPopup(`<b>${p.name}</b>`);

    const buf = L.circle(p.pos, {radius:BUFFER_RADIUS_M, color:'#ff9f1c', weight:1, fillColor:'#ff9f1c', fillOpacity:0.08});

    buf.addTo(map);

    buffers.push({layer:buf, center:p.pos});

  });



  // —— UTYLITY —— //

  const logEl = document.getElementById('log');

  const toastEl = document.getElementById('toast');

  const rcbBanner = document.getElementById('rcbBanner');



  function log(msg){

    const t = new Date().toLocaleTimeString();

    const p = document.createElement('p');

    p.innerHTML = `[${t}] ${msg}`;

    logEl.prepend(p);

  }

  function toast(txt){

    const n = document.createElement('div');

    n.className='t';

    n.textContent=txt;

    toastEl.appendChild(n);

    setTimeout(()=>{ n.style.opacity='0'; n.style.transition='opacity .4s'; }, 2500);

    setTimeout(()=>{ if(n.parentNode) toastEl.removeChild(n); }, 3000);

  }

  function rnd(a,b){ return a + Math.random()*(b-a); }

  function jitterCoord([lat,lng], m=250){

    const dLat = (m/111111) * (Math.random()-.5);

    const dLng = (m/(111111*Math.cos(lat*Math.PI/180))) * (Math.random()-.5);

    return [lat + dLat, lng + dLng];

  }

  function inAnyBuffer(latlng){ return buffers.some(b=> map.distance(latlng, b.center) <= BUFFER_RADIUS_M); }

  function updateStats(){

    document.getElementById('statDrones').textContent = state.drones.length;

    document.getElementById('statViol').textContent = state.stats.violations;

    document.getElementById('statPanic').textContent = `${state.stats.panic}%`;

    const casEl = document.getElementById('statCas'); if(casEl) casEl.textContent = state.stats.casualties;

  }



  // —— DRONY —— //

  function makeDroneIcon({threat=false, label='—'}){

    const el = document.createElement('div');

    el.className = 'drone-visual' + (threat? ' threat pulse':'' );

    el.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center"><div class='tri'></div><div style='font-size:10px;margin-top:2px'>${label}</div></div>`;

    return L.divIcon({className:'', html:el.outerHTML, iconSize:[44,44], iconAnchor:[22,22]});

  }

  const DRONE_TYPES = [ 'REKONESANS', 'TOWAROWY', 'UDERZENIOWY', 'INSPEKCYJNY' ];

  function detectTypeProbabilistic(){

    const r = Math.random();

    if(r<0.6) return DRONE_TYPES[Math.floor(Math.random()*DRONE_TYPES.length)];

    if(r<0.85) return 'NIEPEŁNA_IDENTYFIKACJA';

    return 'NIEZNANY';

  }

  function spawnDrone(){

    const start = jitterCoord(KUTNO, 900);

    const detected = detectTypeProbabilistic();

    const marker = L.marker(start,{icon: makeDroneIcon({threat:false,label:detected==='NIEZNANY'?'?':detected.slice(0,3)})}).addTo(map);

    marker.bindPopup(`<b>Dron</b><br/><b>Typ (detekcja):</b> ${detected==='NIEZNANY' ? '<span style="color:#ffd166">NIEZNANY</span>' : detected}`);

    marker.bindTooltip(detected, {permanent:true, direction:'top', className:'drone-label'}).openTooltip();

    const path = [start, jitterCoord(KUTNO, 700), jitterCoord(KUTNO, 700), jitterCoord(KUTNO, 700)];

    const d = { marker, pathIndex:0, path, detectedType:detected, trueType: DRONE_TYPES[Math.floor(Math.random()*DRONE_TYPES.length)] };

    state.drones.push(d);

    log(`Nowy obiekt powietrzny śledzony — detekcja: <b>${d.detectedType}</b>`);

  }

  for(let i=0;i<DRONE_COUNT;i++) spawnDrone();



  function setMarkerThreatVisual(d, isThreat){

    const label = isThreat ? (d.detectedType==='NIEZNANY' ? '?!' : d.detectedType.slice(0,3)) :

                             (d.detectedType==='NIEZNANY' ? '?' : d.detectedType.slice(0,3));

    d.marker.setIcon(makeDroneIcon({threat:isThreat,label}));

    d.marker.setPopupContent(`<b>Dron</b><br/><b>Typ (detekcja):</b> ${d.detectedType==='NIEZNANY' ? '<span style="color:#ffd166">NIEZNANY</span>' : d.detectedType}<br/><b>Typ (prawdopodobny):</b> ${d.trueType}`);

    d.marker.unbindTooltip();

    d.marker.bindTooltip(d.detectedType, {permanent:true, direction:'top', className:'drone-label'}).openTooltip();

  }



  function moveDrones(){

    state.drones.forEach(d=>{

      d.pathIndex = (d.pathIndex + 1) % d.path.length;

      const next = d.path[d.pathIndex];

      d.marker.setLatLng(next);

      const violation = inAnyBuffer(next);

      if(violation){

        state.stats.violations++;

        setMarkerThreatVisual(d, true);

        log(`<span style="color:var(--bad)">Naruszenie strefy buforowej</span> — dron wykryty przy punkcie wrażliwym. Detekcja: <b>${d.detectedType}</b>`);

      } else {

        setMarkerThreatVisual(d, false);

      }

    });

    if(!state.alerts.rcb && state.stats.panic < 30){ state.stats.panic += 1; }

    updateStats();

  }

  const timer = setInterval(moveDrones, MOVE_MS);



  // —— JEDNOSTKI —— //

  const unitsEl = document.getElementById('units');

  function renderUnits(){

    unitsEl.innerHTML = '';

    state.units.forEach(u=>{

      const row = document.createElement('div');

      row.className = 'unit';

      row.innerHTML = `<span class="n">${u.id}</span><span class="t" style="color:${u.available? 'var(--good)':'var(--warn)'}">${u.available? 'gotowa':'w akcji'}</span>`;

      const btn = document.createElement('button');

      btn.className = 'btn btn-acc';

      btn.textContent = u.available ? 'Wyślij' : 'Przywróć';

      btn.onclick = ()=>{ toggleUnit(u); };

      row.appendChild(btn);

      unitsEl.appendChild(row);

    });

  }

  function unitDot(color='#68ff8b'){

    return L.divIcon({html:`<div style="width:12px;height:12px;border-radius:50%;background:${color};box-shadow:0 0 8px ${color}88"></div>`, iconSize:[12,12], iconAnchor:[6,6]});

  }

  function animateMove(marker, from, to, ms=5000){

    const steps = Math.max(24, Math.floor(ms/50));

    let i=0; const latStep=(to.lat-from.lat)/steps, lngStep=(to.lng-from.lng)/steps;

    return new Promise(res=>{

      const h = setInterval(()=>{

        i++; marker.setLatLng([from.lat+latStep*i, from.lng+lngStep*i]);

        if(i>=steps){ clearInterval(h); res(); }

      }, 50);

    });

  }

  async function toggleUnit(u){

    if(u.available){

      const target = state.drones[ Math.floor(Math.random()*state.drones.length) ];

      if(target){

        const start = jitterCoord(KUTNO, 400);

        const m = L.marker(start, {icon: unitDot()}).addTo(map).bindPopup(`Jednostka ${u.id}`).openPopup();

        u._marker = m; u.available=false; renderUnits();

        log(`Jednostka <b>${u.id}</b> wysłana w rejon aktywności drona (detekcja: ${target.detectedType}).`);

        await animateMove(m, L.latLng(start[0],start[1]), target.marker.getLatLng(), 6000);

        toast(`${u.id} dotarła w rejon incydentu`);

      }

    } else {

      if(u._marker){ map.removeLayer(u._marker); u._marker=null; }

      u.available=true; renderUnits();

      log(`Jednostka <b>${u.id}</b> powróciła i jest gotowa.`);

    }

  }

  renderUnits();



  // —— MODALE (otwieranie/zamykanie) —— //

  function openModal(id){ document.getElementById(id).style.display='grid'; }

  function closeModal(id){ document.getElementById(id).style.display='none'; }

  document.querySelectorAll('[data-close]').forEach(b=>{

    b.addEventListener('click',()=> closeModal(b.getAttribute('data-close')));

  });



  // 1) RCB

  document.getElementById('btnAlert').onclick = ()=> openModal('modalAlert');

  document.getElementById('rcbSend').onclick = ()=>{

    const txt = document.getElementById('rcbText').value.trim();

    state.alerts.rcb = true;

    document.getElementById('status').textContent = 'STAN: ALARM INFORMACYJNY RCB';

    rcbBanner.style.display='block';

    rcbBanner.textContent = `RCB: ${txt}`;

    setTimeout(()=> rcbBanner.style.display='none', 6000);

    const drop = 2 + Math.floor(Math.random()*4);

    state.stats.panic = Math.max(1, state.stats.panic - drop);

    updateStats();

    log(`<b>Komunikat RCB</b> — "${txt}" (spadek paniki o ${drop} pp).`);

    toast('Komunikat RCB wysłany');

    closeModal('modalAlert');

  };



  // 2) No-fly zone

  const airBtn = document.getElementById('btnCloseAir');

  const airArmBtn = document.getElementById('airArm');

  const airClearBtn = document.getElementById('airClear');

  airBtn.onclick = ()=> openModal('modalAir');



  airArmBtn.onclick = ()=>{

    state.alerts.airspaceClosed = true;

    toast('Kliknij w mapę, aby dodać strefę no-fly');

    closeModal('modalAir');

    state.armed.air = true;

  };

  map.on('click', (e)=>{

    if(state.armed.air){

      const r = Number(document.getElementById('airRadius').value||800);

      const zone = L.circle(e.latlng,{radius:r, color:'#a66cff', weight:2, fillColor:'#a66cff', fillOpacity:0.12, dashArray:'6 6'}).addTo(map);

      state.overlays.nofly.push(zone);

      log(`<b>Zamknięto przestrzeń</b> — strefa no-fly r=${r} m w punkcie ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}.`);

      toast('Dodano strefę no-fly');

      state.armed.air=false;

    }

    if(state.armed.panic){

      addPanicSpot(e.latlng, Number(document.getElementById('panicRadius').value||120));

      toast('Dodano ognisko paniki');

    }

  });

  airClearBtn.onclick = ()=>{

    state.overlays.nofly.forEach(z=>map.removeLayer(z));

    state.overlays.nofly=[];

    log('Usunięto wszystkie strefy no-fly.');

    toast('Wyczyszczono strefy no-fly');

  };



  // 3) Notify services

  document.getElementById('btnNotify').onclick = ()=> openModal('modalNotify');

  document.getElementById('srvDispatch').onclick = async ()=>{

    const count = Number(document.getElementById('srvCount').value||1);

    const selected = [...document.querySelectorAll('.srv:checked')].map(x=>x.value);

    closeModal('modalNotify');



    if(selected.length===0){ toast('Nie wybrano służb'); return; }



    const pool = state.units.filter(u=>u.available);

    let dispatched=0;

    for(const u of pool){

      if(dispatched>=count) break;

      if(selected.includes(u.type) || selected.includes((u.type||'').toString())){

        await toggleUnit(u); dispatched++;

      }

    }

    log(`<b>Powiadomiono służby</b>: ${selected.join(', ')}. Wysłano ${dispatched} jednostek.`);

    toast(`Wysłano ${dispatched}/${count} jednostek`);

  };



  // 4) Panic/Evac

  document.getElementById('btnEvac').onclick = ()=> openModal('modalPanic');

  const panicArmBtn = document.getElementById('panicArm');

  const panicAutoBtn = document.getElementById('panicAuto');

  const panicClearBtn = document.getElementById('panicClear');



  function panicIcon(){

    return L.divIcon({html:`<div class="panic-dot panic-anim"></div>`, iconSize:[16,16], iconAnchor:[8,8]});

  }

  function addPanicSpot(latlng, radius){

    const dot = L.marker(latlng,{icon: panicIcon()}).addTo(map).bindPopup('Ognisko paniki');

    const aura = L.circle(latlng,{radius, color:'#ff3d3d', weight:1, fillColor:'#ff3d3d', fillOpacity:0.1}).addTo(map);

    state.overlays.panic.push(dot, aura);

  }

  panicArmBtn.onclick = ()=>{

    state.armed.panic = true;

    closeModal('modalPanic');

    const delta = Number(document.getElementById('panicDelta').value||5);

    state.stats.panic = Math.min(100, state.stats.panic + delta);

    updateStats();

    log(`Zarządzono działania ewakuacyjne — wzrost paniki o ${delta} pp. Kliknięcia na mapie dodają ogniska.`);

    toast('Tryb dodawania ognisk paniki');

  };

  panicAutoBtn.onclick = ()=>{

    const n = Number(document.getElementById('panicCount').value||5);

    const rad = Number(document.getElementById('panicRadius').value||120);

    for(let i=0;i<n;i++){ addPanicSpot(L.latLng(jitterCoord(KUTNO, 600)), rad); }

    const delta = Number(document.getElementById('panicDelta').value||5);

    state.stats.panic = Math.min(100, state.stats.panic + delta);

    updateStats();

    log(`Dodano automatycznie ${n} ognisk paniki (r=${rad} m). Wzrost paniki o ${delta} pp.`);

    toast(`Dodano ${n} ognisk paniki`);

    closeModal('modalPanic');

  };

  panicClearBtn.onclick = ()=>{

    state.overlays.panic.forEach(p=>map.removeLayer(p));

    state.overlays.panic=[];

    log('Wyczyszczono ogniska paniki.');

    toast('Wyczyszczono ogniska paniki');

  };



  // —— ATAKI DRONÓW —— //

  const ATTACK_CHECK_MS = 15000;   // co 15 s sprawdzamy możliwość ataku

  const ATTACK_PROB = 0.35;        // 35% szansy przy każdym sprawdzeniu

  const ATTACK_RADIUS_M = 120;     // promień strefy skutków



  function impactIcon(){

    return L.divIcon({html:`<div class="impact-dot"></div>`, iconSize:[18,18], iconAnchor:[9,9]});

  }

  function pickRandomDrone(){ return state.drones.length ? state.drones[Math.floor(Math.random()*state.drones.length)] : null; }



  function triggerAttack(){

    const d = pickRandomDrone();

    if(!d) return;



    const epicenter = d.marker.getLatLng();

    const zone = L.circle(epicenter, {

      radius: ATTACK_RADIUS_M,

      color:'#ff1e1e', weight:2, fillColor:'#ff1e1e', fillOpacity:.15

    }).addTo(map);



    // miganie

    setTimeout(()=>{ const el = zone.getElement?.() || zone._path; if(el) el.classList.add('attack-zone'); }, 0);



    const mark = L.marker(epicenter, {icon: impactIcon()}).addTo(map).bindPopup('Miejsce uderzenia').openPopup();



    const victims = 1 + Math.floor(Math.random()*4); // 1–4

    state.stats.casualties += victims;

    const panicJump = 8 + Math.floor(Math.random()*7); // 8–14

    state.stats.panic = Math.min(100, state.stats.panic + panicJump);

    updateStats();



    log(`<b style="color:#ff4d4d">ATAK DRONA</b> — ofiary śmiertelne: <b>${victims}</b>, wzrost paniki: <b>${panicJump} pp</b>.`);

    toast(`Atak drona! Ofiary: ${victims}, panika +${panicJump} pp`);



    if(!state.alerts.rcb){

      document.getElementById('status').textContent = 'STAN: ALARM INFORMACYJNY RCB';

    }



    setTimeout(()=>{

      try{ map.removeLayer(zone); map.removeLayer(mark); }catch(e){}

    }, 12000);

  }



  setInterval(()=>{ if(Math.random()<ATTACK_PROB) triggerAttack(); }, ATTACK_CHECK_MS);



  // —— RAPORT —— //

  const modalRep = document.getElementById('reportModal');

  document.getElementById('btnReport').onclick = ()=>{

    const durMs = Date.now() - state.startedAt;

    const mins = Math.floor(durMs/60000), secs = Math.floor((durMs%60000)/1000);

    document.getElementById('repTime').textContent = `${mins}m ${secs}s`;

    document.getElementById('repDrones').textContent = state.drones.length;

    document.getElementById('repViol').textContent = state.stats.violations;

    document.getElementById('repUnits').textContent = state.units.filter(u=>!u.available).length;



    const rec = document.getElementById('repRec'); rec.innerHTML = '';

    const li = (t)=>{ const x=document.createElement('li'); x.textContent=t; rec.appendChild(x); };

    if(state.stats.violations>2) li('Rozważ zwiększenie liczby patroli dronów obserwacyjnych / punktów detekcji.');

    if(!state.alerts.rcb) li('Komunikat RCB nie został uruchomiony — rozważ szybszą aktywację.');

    if(state.units.filter(u=>!u.available).length===0) li('Brak wysłanych jednostek — w realnym scenariuszu niezbędna interwencja.');

    if(state.overlays.nofly.length===0) li('Brak stref no-fly — przy eskalacji wyznacz co najmniej jedną.');

    if(rec.children.length===0) li('Działania skoordynowane prawidłowo w czasie symulacji.');



    modalRep.style.display = 'grid';

    modalRep.setAttribute('aria-hidden','false');

  };

  document.getElementById('btnCloseReport').onclick = ()=>{

    modalRep.style.display = 'none';

    modalRep.setAttribute('aria-hidden','true');

  };



  // —— RESET —— //

  document.getElementById('btnReset').onclick = ()=>{

    clearInterval(timer);

    location.reload();

  };



  // —— START LOG —— //

  log('Symulacja uruchomiona. Monitorowanie ruchu obiektów powietrznych nad Kutnem.');

})();

</script>

</body>

</html>
